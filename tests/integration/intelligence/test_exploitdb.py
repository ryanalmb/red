import pytest
import asyncio
from cyberred.intelligence.sources.exploitdb import ExploitDbSource
from cyberred.intelligence.base import IntelPriority

@pytest.mark.integration
class TestExploitDbIntegration:
    @pytest.mark.asyncio
    async def test_health_check_real(self):
        """Test health check against real searchsploit."""
        source = ExploitDbSource()
        is_healthy = await source.health_check()
        assert is_healthy is True

    @pytest.mark.asyncio
    async def test_query_real_vsftpd(self):
        """Test real searchsploit query for vsftpd 2.3.4."""
        source = ExploitDbSource()
        results = await source.query("vsftpd", "2.3.4")
        
        assert len(results) > 0
        
        # Verify specific known exploit
        found = False
        for res in results:
            if "17491" in res.metadata.get("edb_id", ""):
                found = True
                assert res.source == "exploitdb"
                assert res.priority == IntelPriority.EXPLOITDB
                assert "Backdoor Command Execution" in res.metadata["title"]
                assert res.severity in ["high", "critical"] # remote type
                break
        
        assert found, "Expected vsftpd 2.3.4 exploit (17491) not found"

    @pytest.mark.asyncio
    async def test_query_no_results(self):
        """Test query returning no results."""
        source = ExploitDbSource()
        results = await source.query("nonexistent_service_12345", "1.0")
        assert results == []
