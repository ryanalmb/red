"""Integration tests for Exploitation parsers with production-like outputs.

These tests verify that parsers correctly handle real-world tool output formats
as they would be encountered during actual penetration testing engagements.
"""
import pytest
import uuid

from cyberred.tools.parsers import (
    crackmapexec_parser, responder_parser, secretsdump_parser,
    psexec_parser, metasploit_parser, searchsploit_parser
)


@pytest.fixture
def agent_id():
    """Generate a unique agent ID for each test."""
    return str(uuid.uuid4())


# ============================================================================
# CRACKMAPEXEC INTEGRATION TESTS
# ============================================================================

CME_SMB_OUTPUT = '''SMB         192.168.1.10    445    DC01             [*] Windows Server 2019 Standard 17763 x64 (name:DC01) (domain:CORP.LOCAL) (signing:True) (SMBv1:False)
SMB         192.168.1.10    445    DC01             [+] CORP.LOCAL\\administrator:Password123! (Pwn3d!)
SMB         192.168.1.10    445    DC01             [*] Enumerated shares
SMB         192.168.1.10    445    DC01             Share           Permissions     Remark
SMB         192.168.1.10    445    DC01             -----           -----------     ------
SMB         192.168.1.10    445    DC01             ADMIN$          READ,WRITE      Remote Admin
SMB         192.168.1.10    445    DC01             C$              READ,WRITE      Default share
SMB         192.168.1.10    445    DC01             IPC$            READ            Remote IPC
SMB         192.168.1.10    445    DC01             NETLOGON        READ            Logon server share
SMB         192.168.1.10    445    DC01             SYSVOL          READ            Logon server share'''

CME_WINRM_OUTPUT = '''WINRM       192.168.1.10    5985   DC01             [*] Windows Server 2019 Standard 17763 (name:DC01) (domain:CORP.LOCAL)
WINRM       192.168.1.10    5985   DC01             [+] CORP.LOCAL\\svc_backup:BackupPassword1 (Admin!)'''

CME_LAPS_OUTPUT = '''SMB         192.168.1.10    445    DC01             [+] CORP.LOCAL\\administrator:Password123!
SMB         192.168.1.10    445    DC01             [*] LAPS password: rK9@jL2#pM4$
SMB         192.168.1.10    445    DC01             [+] CORP.LOCAL\\DESKTOP-ABC123$:rK9@jL2#pM4$ (Pwn3d!)'''


@pytest.mark.integration
class TestCrackmapexecIntegration:
    """Integration tests for crackmapexec parser with production outputs."""
    
    def test_cme_smb_credential_extraction(self, agent_id):
        """Test CME SMB output with successful authentication."""
        findings = crackmapexec_parser(CME_SMB_OUTPUT, "", 0, agent_id, "192.168.1.10")
        
        cred_findings = [f for f in findings if f.type == "credential"]
        assert len(cred_findings) >= 1
        assert any("administrator" in f.evidence.lower() for f in cred_findings)
        assert any(f.severity == "critical" for f in cred_findings)
    
    def test_cme_share_enumeration(self, agent_id):
        """Test CME share enumeration output."""
        findings = crackmapexec_parser(CME_SMB_OUTPUT, "", 0, agent_id, "192.168.1.10")
        
        share_findings = [f for f in findings if f.type == "share"]
        # Should find ADMIN$, C$, IPC$, NETLOGON, SYSVOL
        assert len(share_findings) >= 3
    
    def test_cme_winrm_output(self, agent_id):
        """Test CME WinRM authentication output."""
        findings = crackmapexec_parser(CME_WINRM_OUTPUT, "", 0, agent_id, "192.168.1.10")
        
        cred_findings = [f for f in findings if f.type == "credential"]
        assert len(cred_findings) >= 1


# ============================================================================
# RESPONDER INTEGRATION TESTS
# ============================================================================

RESPONDER_OUTPUT = '''[+] Listening for events...
[SMB] NTLMv2-SSP Client   : 192.168.1.50
[SMB] NTLMv2-SSP Username : CORP\\jsmith
[SMB] NTLMv2-SSP Hash     : jsmith::CORP:1122334455667788:AABBCCDD11223344AABBCCDD11223344:010100000000000080F3C2CAFE7ED901AABBCCDD11223344

[HTTP] NTLMv2 Client   : 192.168.1.51
[HTTP] NTLMv2 Username : CORP\\admin
[HTTP] NTLMv2 Hash     : admin::CORP:5566778899aabbcc:DDEE11223344AABB556677889900AABB:0101000000000000

[LDAP] NTLMv2 Client   : 192.168.1.52
[LDAP] NTLMv2 Username : CORP\\svc_sql
[LDAP] NTLMv2 Hash     : svc_sql::CORP:aabbccddeeff0011:22334455667788990011223344556677:0101000000000000'''


@pytest.mark.integration
class TestResponderIntegration:
    """Integration tests for responder parser with production outputs."""
    
    def test_responder_multiple_protocols(self, agent_id):
        """Test responder capturing hashes from multiple protocols."""
        findings = responder_parser(RESPONDER_OUTPUT, "", 0, agent_id, "192.168.1.1")
        
        cred_findings = [f for f in findings if f.type == "credential"]
        assert len(cred_findings) >= 3
        
        # Verify all protocols captured
        evidence_text = " ".join(f.evidence for f in cred_findings)
        assert "jsmith" in evidence_text
        assert "admin" in evidence_text
        assert "svc_sql" in evidence_text
    
    def test_responder_hash_severity(self, agent_id):
        """Test that captured hashes are marked as high severity."""
        findings = responder_parser(RESPONDER_OUTPUT, "", 0, agent_id, "192.168.1.1")
        
        # All credential captures should be high severity
        cred_findings = [f for f in findings if f.type == "credential"]
        assert all(f.severity in ["high", "critical"] for f in cred_findings)


# ============================================================================
# SECRETSDUMP INTEGRATION TESTS
# ============================================================================

SECRETSDUMP_OUTPUT = '''Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Target system bootKey: 0x123456789abcdef0123456789abcdef0
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:8846f7eaee8fb117ad06bdd830b7586c:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[*] Dumping cached domain logon information (domain/username:hash)
CORP.LOCAL/jsmith:$DCC2$10240#jsmith#aabbccdd11223344aabbccdd11223344
CORP.LOCAL/admin:$DCC2$10240#admin#11223344aabbccdd11223344aabbccdd
[*] Dumping LSA Secrets
[*] $MACHINE.ACC
CORP\\DC01$:aes256-cts-hmac-sha1-96:aabbccdd11223344aabbccdd1122334455667788990011223344556677889900
CORP\\DC01$:aes128-cts-hmac-sha1-96:aabbccdd11223344aabbccdd11223344
[*] DPAPI_SYSTEM
dpapi_machinekey:0xaabbccdd11223344aabbccdd1122334455667788
dpapi_userkey:0x11223344aabbccdd11223344aabbccdd55667788
[*] NL$KM
0000   AA BB CC DD 11 22 33 44  AA BB CC DD 11 22 33 44   ...."3D...."3D
[*] Cleaning up...'''


@pytest.mark.integration
class TestSecretsdumpIntegration:
    """Integration tests for secretsdump parser with production outputs."""
    
    def test_secretsdump_sam_hashes(self, agent_id):
        """Test secretsdump SAM hash extraction."""
        findings = secretsdump_parser(SECRETSDUMP_OUTPUT, "", 0, agent_id, "192.168.1.10")
        
        cred_findings = [f for f in findings if f.type == "credential"]
        
        # Should find Administrator hash (not Guest/DefaultAccount with empty hashes)
        admin_findings = [f for f in cred_findings if "Administrator" in f.evidence or "administrator" in f.evidence.lower()]
        assert len(admin_findings) >= 1
    
    def test_secretsdump_kerberos_keys(self, agent_id):
        """Test secretsdump Kerberos key extraction."""
        findings = secretsdump_parser(SECRETSDUMP_OUTPUT, "", 0, agent_id, "192.168.1.10")
        
        # Should extract machine account Kerberos keys
        cred_findings = [f for f in findings if f.type == "credential"]
        assert len(cred_findings) >= 2


# ============================================================================
# PSEXEC INTEGRATION TESTS
# ============================================================================

PSEXEC_SUCCESS_OUTPUT = '''Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on 192.168.1.10.....
[*] Found writable share ADMIN$
[*] Uploading file QxzOJPcw.exe
[*] Opening SVCManager on 192.168.1.10.....
[*] Creating service ABCD on 192.168.1.10.....
[*] Starting service ABCD.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.1]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\\Windows\\system32>whoami
nt authority\\system

C:\\Windows\\system32>'''

PSEXEC_FAILURE_OUTPUT = '''Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on 192.168.1.10.....
[-] SMB SessionError: STATUS_ACCESS_DENIED({Access Denied})'''


@pytest.mark.integration
class TestPsexecIntegration:
    """Integration tests for psexec parser with production outputs."""
    
    def test_psexec_successful_shell(self, agent_id):
        """Test psexec successful shell access detection."""
        findings = psexec_parser(PSEXEC_SUCCESS_OUTPUT, "", 0, agent_id, "192.168.1.10")
        
        shell_findings = [f for f in findings if f.type == "shell_access"]
        assert len(shell_findings) >= 1
        assert shell_findings[0].severity == "critical"
    
    def test_psexec_failure_output(self, agent_id):
        """Test psexec failure - should not report false positives."""
        findings = psexec_parser(PSEXEC_FAILURE_OUTPUT, "", 0, agent_id, "192.168.1.10")
        
        shell_findings = [f for f in findings if f.type == "shell_access"]
        assert len(shell_findings) == 0


# ============================================================================
# METASPLOIT INTEGRATION TESTS
# ============================================================================

METASPLOIT_OUTPUT = '''[*] Started reverse TCP handler on 192.168.1.100:4444
[*] 192.168.1.10:445 - Connecting to target for exploitation.
[+] 192.168.1.10:445 - Connection established for exploitation.
[+] 192.168.1.10:445 - Target OS selected valid for OS indicated by SMB reply
[*] 192.168.1.10:445 - CORE RAW://192.168.1.10:445/ntsvcs > DCERPC BIND call returned 0
[*] 192.168.1.10:445 - exploit/windows/smb/ms17_010_eternalblue - CORE RAW SHELLCODE - Sending payload
[*] Meterpreter session 1 opened (192.168.1.100:4444 -> 192.168.1.10:49158) at 2023-01-15 10:00:00 -0500

[*] 192.168.1.11:445 - Host is VULNERABLE to MS17-010
[+] 192.168.1.11:445 - exploit/windows/smb/ms17_010_eternalblue - WIN - Target appears vulnerable

[*] Command shell session 2 opened (192.168.1.100:4445 -> 192.168.1.12:49159) at 2023-01-15 10:05:00 -0500'''


@pytest.mark.integration
class TestMetasploitIntegration:
    """Integration tests for metasploit parser with production outputs."""
    
    def test_metasploit_meterpreter_session(self, agent_id):
        """Test metasploit meterpreter session detection."""
        findings = metasploit_parser(METASPLOIT_OUTPUT, "", 0, agent_id, "192.168.1.10")
        
        session_findings = [f for f in findings if f.type == "session"]
        assert len(session_findings) >= 2  # Meterpreter and Command shell
        
        meterpreter = [f for f in session_findings if "Meterpreter" in f.evidence]
        assert len(meterpreter) >= 1
        assert meterpreter[0].severity == "critical"
    
    def test_metasploit_vuln_detection(self, agent_id):
        """Test metasploit vulnerability detection."""
        findings = metasploit_parser(METASPLOIT_OUTPUT, "", 0, agent_id, "192.168.1.10")
        
        vuln_findings = [f for f in findings if f.type == "vuln"]
        assert len(vuln_findings) >= 1
    
    def test_metasploit_exploit_success(self, agent_id):
        """Test metasploit exploit success detection."""
        findings = metasploit_parser(METASPLOIT_OUTPUT, "", 0, agent_id, "192.168.1.10")
        
        # Should detect the exploit success markers
        exploit_findings = [f for f in findings if "exploit" in f.evidence.lower()]
        assert len(exploit_findings) >= 1


# ============================================================================
# SEARCHSPLOIT INTEGRATION TESTS
# ============================================================================

SEARCHSPLOIT_JSON_OUTPUT = '''{
    "SEARCH": "apache 2.4",
    "DB_PATH_EXPLOIT": "/usr/share/exploitdb",
    "RESULTS_EXPLOIT": [
        {"Title": "Apache HTTP Server 2.4.49 - Path Traversal & RCE", "EDB-ID": "50383", "Date": "2021-10-05", "Author": "Lucas Pedrini", "Type": "webapps", "Platform": "linux", "Path": "exploits/linux/webapps/50383.sh"},
        {"Title": "Apache HTTP Server 2.4.50 - Path Traversal (CVE-2021-42013)", "EDB-ID": "50406", "Date": "2021-10-07", "Author": "Lucas Pedrini", "Type": "webapps", "Platform": "multiple", "Path": "exploits/multiple/webapps/50406.py"},
        {"Title": "Apache 2.4.7 mod_status - Scoreboard Handling Race Condition", "EDB-ID": "34133", "Date": "2014-07-21", "Author": "Matthew Daley", "Type": "dos", "Platform": "linux", "Path": "exploits/linux/dos/34133.txt"}
    ]
}'''

SEARCHSPLOIT_STDOUT_OUTPUT = '''------------------------------------------------------------------------------------------------ ---------------------------------
 Exploit Title                                                                                  |  Path
------------------------------------------------------------------------------------------------ ---------------------------------
Apache HTTP Server 2.4.49 - Path Traversal & RCE                                               | exploits/linux/webapps/50383.sh
Apache HTTP Server 2.4.50 - Path Traversal (CVE-2021-42013)                                    | exploits/multiple/webapps/50406.py
Apache 2.4.7 mod_status - Scoreboard Handling Race Condition                                   | exploits/linux/dos/34133.txt
------------------------------------------------------------------------------------------------ ---------------------------------
Shellcodes: No Results'''


@pytest.mark.integration
class TestSearchsploitIntegration:
    """Integration tests for searchsploit parser with production outputs."""
    
    def test_searchsploit_json_production_output(self, agent_id):
        """Test searchsploit JSON output format (-j flag)."""
        findings = searchsploit_parser(SEARCHSPLOIT_JSON_OUTPUT, "", 0, agent_id, "192.168.1.1")
        
        assert len(findings) >= 3
        assert all(f.type == "exploit_ref" for f in findings)
        assert all(f.tool == "searchsploit" for f in findings)
        
        # Verify EDB IDs extracted
        evidence = " ".join(f.evidence for f in findings)
        assert "50383" in evidence
        assert "50406" in evidence
    
    def test_searchsploit_stdout_production_output(self, agent_id):
        """Test searchsploit stdout format (table output)."""
        findings = searchsploit_parser(SEARCHSPLOIT_STDOUT_OUTPUT, "", 0, agent_id, "192.168.1.1")
        
        assert len(findings) >= 3
        assert all(f.type == "exploit_ref" for f in findings)
        
        # Verify titles extracted
        evidence = " ".join(f.evidence for f in findings)
        assert "Path Traversal" in evidence or "50383" in evidence
